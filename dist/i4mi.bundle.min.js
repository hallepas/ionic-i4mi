!function(e){try{e=angular.module("i4mi.templates")}catch(t){e=angular.module("i4mi.templates",[])}e.run(["$templateCache",function(e){e.put("i4mi.midata.chart.html","<nvd3 options=options data=data></nvd3>")}])}(),function(e){try{e=angular.module("i4mi.templates")}catch(t){e=angular.module("i4mi.templates",[])}e.run(["$templateCache",function(e){e.put("i4mi.midata.entry.html",'<div ng-if="viewClass === \'modal\'" class={{viewClass}}><ion-header-bar><h1 class=title>MIDATA</h1></ion-header-bar><ion-content><div ng-show=info.text class="item item-{{info.type}} i4mi-info">{{info.text}}</div><formly-form model=model fields=schema><div ng-if="native+\'\' === \'true\'" class="item item-input"><input type=datetime ng-model=datetime></div><div ng-if="native+\'\' !== \'true\'" class="button-bar item item-input i4mi-datetime"><button class="button button-light" ng-click=openDatePicker()>{{ datetime | date:\'dd. MMMM yyyy\' }}</button> <button ionic-timepicker input-obj=tpo class="button button-light">{{ datetime | date:\'HH:mm\' }}</button></div><div class="button-bar i4mi-options"><button class=button ng-click=closeModal()>Cancel</button> <button type=submit class="button button-positive" ng-click=add(model)>Add Entry</button></div></formly-form></ion-content></div><div ng-if="viewClass === \'widget\'" class={{viewClass}}><div ng-show=info.text class="item item-{{info.type}} i4mi-info">{{info.text}}</div><formly-form model=model fields=schema><div ng-if="native+\'\' === \'true\'" class="item item-input"><input type=datetime ng-model=datetime></div><div ng-if="native+\'\' !== \'true\'" class="button-bar item item-input i4mi-datetime"><button class="button button-light" ng-click=openDatePicker()>{{ datetime | date:\'dd. MMMM yyyy\' }}</button> <button ionic-timepicker input-obj=tpo class="button button-light">{{ datetime | date:\'HH:mm\' }}</button></div><button type=submit class="button button-block button-positive" ng-click=add(model)>Add Entry</button></formly-form></div>')}])}(),function(e){try{e=angular.module("i4mi.templates")}catch(t){e=angular.module("i4mi.templates",[])}e.run(["$templateCache",function(e){e.put("i4mi.midata.list.html",'<ion-list can-swipe="canSwipe !== \'false\'"><ion-item ng-if="record.data.status !== \'entered-in-error\'" ng-repeat="record in records"><div ng-if="!templateUrl || templateUrl === \'\'"><div ng-if=!record.data.valueQuantity><h3><span class=i4mi-name>{{ record.name }}</span></h3><h2><div ng-repeat="(key,value) in record.data track by $index"><div ng-show=shouldShow(key)><span ng-show="showKey !== \'false\'" class=i4mi-key>{{ key }}:</span> <span class=i4mi-value>{{ value }}</span></div></div></h2><h4><span class=i4mi-description>{{ record.description }}</span></h4><h4><span class=i4mi-datetime>{{ record.data.effectiveDateTime | date:\'dd. MMMM yyyy\' }}</span></h4></div><div ng-if=record.data.valueQuantity><h3><span class=i4mi-name>{{ record.name }}</span></h3><h2><span class=i4mi-value>{{ record.data.valueQuantity.value }}</span> <span class=i4mi-unit>{{ record.data.valueQuantity.unit }}</span></h2><h4><span class=i4mi-description>{{ record.description }}</span></h4><h4 ng-repeat="system in record.data.code.coding"><span class=i4mi-system>{{ system.system }}</span> <span class=i4mi-code>{{ system.code }}</span> <span class=i4mi-display>{{ system.display }}</span></h4><h4><span class=i4mi-datetime>{{ record.data.effectiveDateTime | date:\'dd. MMMM yyyy\' }}</span></h4></div></div><div ng-if="templateUrl !== \'\'"><div class=dynamic-field ng-include=templateUrl></div></div><ion-option-button class=button-assertive ng-click=remove(record)>Remove</ion-option-button></ion-item></ion-list>')}])}(),function(e){try{e=angular.module("i4mi.templates")}catch(t){e=angular.module("i4mi.templates",[])}e.run(["$templateCache",function(e){e.put("i4mi.midata.login.html",'<div ng-if="viewClass === \'modal\'" class={{viewClass}}><ion-header-bar><h1 class=title>MIDATA</h1></ion-header-bar><ion-content><div ng-show=info.text class="item item-{{info.type}} i4mi-info">{{info.text}}</div><formly-form model=user fields=userFields><button type=submit class="button button-block button-positive" ng-click=login(user)>Login</button></formly-form></ion-content></div><div ng-show=!loggedIn ng-if="viewClass === \'widget\'" class={{viewClass}}><div ng-show=info.text class="item item-{{info.type}} i4mi-info">{{info.text}}</div><formly-form model=user fields=userFields><button type=submit class="button button-block button-positive" ng-click=login(user)>Login</button></formly-form></div><div ng-show=loggedIn ng-if="viewClass === \'widget\'" class={{viewClass}}><label class=item>{{currentUser}}</label> <button type=submit class="button button-block button-positive" ng-click=logout()>Logout</button></div>')}])}(),function(e){try{e=angular.module("i4mi.templates")}catch(t){e=angular.module("i4mi.templates",[])}e.run(["$templateCache",function(e){e.put("i4mi.midata.logout.html",'<div ng-if="viewClass === \'modal\'" class={{viewClass}}><ion-header-bar><h1 class=title>MIDATA</h1></ion-header-bar><ion-content><label>{{currentUser}}</label> <button type=submit class="button button-block button-positive" ng-click=logout()>Logout</button></ion-content></div><div ng-if="viewClass === \'widget\'" class={{viewClass}}><label class=item>{{currentUser}}</label> <button type=submit class="button button-block button-positive" ng-click=logout()>Logout</button></div>')}])}(),function(e){try{e=angular.module("i4mi.templates")}catch(t){e=angular.module("i4mi.templates",[])}e.run(["$templateCache",function(e){e.put("i4mi.modal.html","<div class=modal><div class=dynamic-field ng-include=templateUrl></div></div>")}])}(),angular.module("i4mi",["i4mi.templates","ionic","ionic-datepicker","ionic-timepicker","ngStorage","mdo-angular-cryptography"]).controller("I4MIMidataLoginController",["$scope","I4MIMidataService","$timeout",function(e,t,n){e.currentUser=t.currentUser(),e.loggedIn=t.loggedIn(),e.login=function(i){t.auth(i).then(function(a){a.authorized?(e.info={text:a.info,type:"balanced"},n(function(){e.closeModal(),e.info=!1,e.loggedIn=!0,e.currentUser=i.username},700)):(e.loggedIn=t.loggedIn(),e.info={text:a.info,type:"energized"})},function(n){e.loggedIn=t.loggedIn(),e.info={text:n,type:"assertive"}})},e.logout=function(){t.logout(),e.loggedIn=!1,e.currentUser=""},e.userFields=[{key:"username",type:"input",templateOptions:{type:"email",label:"Email address",placeholder:"hello@example.org"}},{key:"password",type:"input",templateOptions:{type:"password",label:"Password",placeholder:"•••••••••••"}},{key:"server",type:"input",templateOptions:{type:"text",label:"MIDATA Server",placeholder:"https://xx.midata.coop"}}]}]).controller("I4MIMidataEntryController",["$scope","$timeout","$ionicPopup","I4MIMidataService","ionicDatePicker",function(e,t,n,i,a){var o=function(t){t=new Date(t),e.datetime.setFullYear(t.getFullYear()),e.datetime.setMonth(t.getMonth()),e.datetime.setDate(t.getDate())};e.openDatePicker=function(){a.openDatePicker({callback:o,inputDate:e.datetime})};var r=function(t){t=new Date(1e3*t),e.datetime.setHours(t.getUTCHours()),e.datetime.setMinutes(t.getUTCMinutes()),e.tpo.inputEpochTime=60*e.datetime.getHours()*60+60*e.datetime.getMinutes()},s=function(){e.model={},e.datetime=new Date,e.datetime.setSeconds(0),e.datetime.setMilliseconds(0),"true"!==e["native"]&&e.datetime.setMinutes(5*Math.round(e.datetime.getMinutes()/5))};s(),e.tpo={callback:r,inputEpochTime:60*e.datetime.getHours()*60+60*e.datetime.getMinutes(),step:5};var l=function(e,t){var n=e.data.$set.split("."),i=[e.data];for(index in n)i.push(i[index][n[index]]);i[i.length-1]=JSON.stringify(t);for(index in n)i[n.length-1-index][n[n.length-1-index]]=i[n.length-index];delete e.data.$set};e.add=function(n){var a=[];if("true"===e.groupEntry||e.groupEntry===!0){var o=JSON.parse(JSON.stringify(e.fhir));l(o,n),o.data.effectiveDateTime=e.datetime,a.push(o)}else for(field in n)if(n.hasOwnProperty(field)&&n[field]&&""!==n[field]){var o=JSON.parse(JSON.stringify(e.fhir[field]));l(o,n[field]),o.data.effectiveDateTime=e.datetime,a.push(o)}i.add(a).then(function(n){n.success?(e.info={text:n.info,type:"balanced"},t(function(){e.closeModal(),"true"===e.clear&&s()},700)):e.info={text:n.info,type:"energized"}},function(t){e.info={text:t,type:"assertive"}})}}]).controller("I4MIMidataChartController",["$scope",function(e){var t,n;"second"===e.interval?(t=19,n=function(e){return e.setMilliseconds(0),e}):"minute"===e.interval?(t=16,n=function(e){return e.setMilliseconds(0),e.setSeconds(0),e}):"hour"===e.interval?(t=16,n=function(e){return e.setMilliseconds(0),e.setSeconds(0),e.setMinutes(0),e}):"day"===e.interval?(t=10,n=function(e){return e.setMilliseconds(0),e.setSeconds(0),e.setMinutes(0),e.setHours(0),e}):"month"===e.interval?(t=7,n=function(e){return e.setMilliseconds(0),e.setSeconds(0),e.setMinutes(0),e.setHours(0),e.setDate(1),e}):"year"===e.interval?(t=4,n=function(e){return e.setMilliseconds(0),e.setSeconds(0),e.setMinutes(0),e.setHours(0),e.setDate(1),e.setMonth(1),e}):(t=30,n=function(e){return e});var i={chart:{type:e.type||"lineChart",height:window.innerHeight/3,margin:{top:20,right:50,bottom:30,left:50},useInteractiveGuideline:!0,showValues:!0,valueFormat:function(e){return e},xAxis:{tickFormat:function(e){return"discreteBarChart"!==i.chart.type&&(e=new Date(e).toJSON(),e=e.substring(0,t).replace(/T/," ")),e}},yAxis:{tickFormat:function(e){return Math.round(e,2)}}}};e.options=i,e.$watch("records",function(){var t={};for(index in e.records){var a=e.records[index];if(a.data&&a.data.valueQuantity&&!isNaN(a.data.valueQuantity.value)&&a.data.effectiveDateTime&&"entered-in-error"!==a.data.status){var o=a.name||"records";t[o]||(t[o]={name:a.name||"",unit:a.data.valueQuantity.unit,data:{}});var r,s=n(new Date(a.data.effectiveDateTime));r="discreteBarChart"===i.chart.type?"all":s.toJSON();var l=t[o].data[r]||{value:0,count:0,first:a.data.valueQuantity.value,xtime:s.getTime()};l.value+=1*a.data.valueQuantity.value,l.count+=1,t[o].data[r]=l}}var u=[];for(o in t)if(t.hasOwnProperty(o)){var d=t[o],c=[];for(r in d.data)if(d.data.hasOwnProperty(r)){l=d.data[r];var m;m="sum"===e.operation?l.value:"avg"===e.operation?l.value/l.count:l.first,c.push({x:l.xtime,y:m})}var p;"discreteBarChart"===i.chart.type?(c[0].x=d.name,p={key:d.name+" ["+d.unit+"]",values:c}):p={key:d.name+" ["+d.unit+"]",values:c},p.values.sort(function(e,t){return e.x<t.x?-1:e.x>t.x?1:0}),u.push(p)}e.data=u})}]).directive("i4miChart",[function(){return{restrict:"E",scope:{type:"@",records:"=",options:"=",interval:"@",operation:"@"},controller:"@",name:"controllerName",link:function(e,t,n){},templateUrl:"i4mi.midata.chart.html"}}]).directive("i4miList",["I4MIMidataService",function(e){return{restrict:"E",scope:{records:"=",canSwipe:"@canRemove",showKey:"@",keys:"@",templateUrl:"@"},link:function(t,n,i){t.shouldShow=function(e){return!i.keys||-1!==(i.keys+",").indexOf(e+",")},t.remove=function(t){t.data.status="entered-in-error",e.update(t)}},templateUrl:"i4mi.midata.list.html"}}]).directive("i4miMidataLogin",[function(){return{restrict:"E",scope:{user:"="},controller:"@",name:"controllerName",templateUrl:"i4mi.midata.login.html",link:function(e,t,n){e.viewClass="widget",e.openModal=function(){},e.closeModal=function(){}}}}]).directive("i4miMidataLogout",[function(){return{restrict:"E",scope:{},controller:"@",name:"controllerName",templateUrl:"i4mi.midata.logout.html",link:function(e,t,n){e.viewClass="widget",e.openModal=function(){},e.closeModal=function(){}}}}]).directive("i4miMidataEntry",[function(){return{restrict:"E",scope:{model:"=",schema:"=fields",fhir:"=",groupEntry:"@",clear:"@","native":"@"},controller:"@",name:"controllerName",templateUrl:"i4mi.midata.entry.html",link:function(e,t,n){e.viewClass="widget",e.openModal=function(){},e.closeModal=function(){e.info=void 0}}}}]).service("I4MIModalService",["$ionicModal","$rootScope","$q","$injector","$controller",function(e,t,n,i,a){function o(i,o,l,u){var d,c=n.defer(),m=t.$new(),p=m.$id;for(var f in l)l.hasOwnProperty(f)&&(m[f]=l[f]);return e.fromTemplateUrl(i,{scope:m,animation:u.animation||"slide-in-up",focusFirstInput:u.focusFirstInput,backdropClickToClose:u.backdropClickToClose,hardwareBackButtonClose:u.hardwareBackButtonClose}).then(function(e){m.modal=e,m.openModal=function(){m.modal.show()},m.closeModal=function(e){c.resolve(e),m.modal.hide()},m.$on("modal.hidden",function(e){if(e.currentScope){var t=e.currentScope.$id;p===t&&(c.resolve(null),r(e.currentScope))}});var t={$scope:m,parameters:u},n=s(o);d=a(o,t),n.isControllerAs&&(d.openModal=m.openModal,d.closeModal=m.closeModal),m.modal.show()},function(e){c.reject(e)}),c.promise}function r(e){e.$destroy(),e.modal&&e.modal.remove()}function s(e){var t={isControllerAs:!1,controllerName:"",propName:""},n=(e||"").trim().split(/\s+/);return t.isControllerAs=3===n.length&&"as"===(n[1]||"").toLowerCase(),t.isControllerAs?(t.controllerName=n[0],t.propName=n[2]):t.controllerName=e,t}return{show:o}}]).service("I4MISettingsService",["$localStorage","$crypto",function(e,t){var n;return n=window.cordova&&cordova.device?cordova.device.uuid||"1234":"1234",e.settings||(e.settings={}),{set:function(i,a){e.settings[i]=t.encrypt(JSON.stringify(a),n)},get:function(i){return e.settings[i]?JSON.parse(t.decrypt(e.settings[i],n)):{}}}}]).service("I4MIMidataService",["I4MIModalService","I4MISettingsService","$q","$http","$crypto","APPNAME","APPSECRET",function(e,t,n,i,a,o,r){var s=o,l=r,u=function(e){var n={encrypted:a.encrypt(JSON.stringify(e),l)};t.set("midata",n)},d=function(){var e=t.get("midata");if(e.encrypted)try{return JSON.parse(a.decrypt(e.encrypted,l))}catch(n){return{}}return{}},c=d(),m=function(){c={},u({})},p=function(e){var t={appname:s,secret:l};return e.refreshToken?t.refreshToken=e.refreshToken:(t.username=e.username,t.password=e.password),e.server="https://"+e.server.replace(/^https*:\/\//,""),n(function(n,a){i({method:"POST",url:e.server+"/v1/auth",data:t}).then(function(t){if("undefined"==typeof t.status||200!=t.status)m(),n({authorized:!1,info:"Login failed."});else{var i=t.data;i.info="Login successfull.",i.authorized=!0,c={},c.credentials=i,c.server=e.server,c.username=e.username,u(c),n(i)}},function(e){m(),a("undefined"==typeof e.data?"Could not connect!":e.data)})})};c.credentials&&""!==c.credentials.refreshToken&&p({refreshToken:c.credentials.refreshToken,username:c.username,server:c.server}).then(function(e){},function(e){});var f=function(e,t,a){return n(function(n,o){if(0===t.length)return n({info:"At least one must not be empty!",success:!1});var r=t[a];return"object"==typeof r.data&&(r.data=JSON.stringify(r.data)),c.credentials&&c.credentials.authToken?(r.authToken=c.credentials.authToken,void i({method:"POST",url:c.server+"/v1/records/"+e,data:r}).then(function(i){"undefined"==typeof i.status||200!=i.status?o("Could not push data to server!"):a<t.length-1?f(e,t,a+1).then(function(e){n(e)},function(e){o(e)}):n({info:"Entrey saved.",success:!0})},function(e){o("Could not push data to server!")})):o("You must login first in order to add a new entry!")})};return{auth:p,login:function(t,i,a){return c.credentials&&""!==c.credentials.authToken?n(function(e,t){e(c.credentials)}):(a=a||c.server,t&&i&&a?p({username:t,password:i,server:a}):e.show("i4mi.midata.login.html","I4MIMidataLoginController",{viewClass:"modal",user:{username:t,password:i,server:a}},{animation:"",focusFirstInput:!0,backdropClickToClose:!1,hardwareBackButtonClose:!1}))},logout:m,loggedIn:function(){return c.credentials&&""!==c.credentials.authToken},currentUser:function(){return c.username},all:function(){return[]},search:function(e,t){return e=e||["data","name"],e.push("_id","version"),t=t||{},n(function(n,a){i({method:"POST",url:c.server+"/v1/records/search",data:{authToken:c.credentials.authToken,fields:e,properties:t}}).then(function(e){if("undefined"==typeof e.status||200!=e.status)a("Connection error!");else{for(index in e.data){var t=e.data[index];try{if("string"==typeof t.data.valueQuantity.value){var i=JSON.parse(t.data.valueQuantity.value);t.data.valueQuantity.value=i}}catch(o){}}n(e)}},function(e){a("Could not connect!")})})},add:function(e){return Array.isArray(e)||(e=[e]),f("create",e,0)},update:function(e){Array.isArray(e)||(e=[e]);for(index in e){var t={_id:e[index]._id,version:e[index].version,data:e[index].data};e[index]=t}return f("update",e,0)},remove:function(e){},newEntry:function(t,n,i,a){return a=a||{},e.show("i4mi.midata.entry.html","I4MIMidataEntryController",{viewClass:"modal",model:t,schema:n,fhir:i,groupEntry:a.groupEntry,clear:a.clear,"native":a["native"]},{animation:"slide-in-up",focusFirstInput:!0,backdropClickToClose:!0,hardwareBackButtonClose:!0})}}}]);